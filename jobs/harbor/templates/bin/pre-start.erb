#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

JOB_NAME=harbor
#Make sure folders are ready
RUN_DIR=/var/vcap/sys/run/$JOB_NAME
LOG_DIR=/var/vcap/sys/log/$JOB_NAME
HARBOR_JOB_DIR=/var/vcap/jobs/$JOB_NAME
PACKAGE_DIR=/var/vcap/packages
HARBOR_PACKAGE_DIR=${PACKAGE_DIR}/harbor-app
OPENSSL_BIN_DIR=${PACKAGE_DIR}/openssl/bin
HARBOR_PERSISTED_DATA=/var/vcap/store/harbor
HARBOR_DATA=/data
CFG_FILE=${HARBOR_JOB_DIR}/config/harbor.cfg
CRON_PATH=/etc/cron.d/$JOB_NAME
CERTS_D=/etc/docker/certs.d

export PATH=$PATH:${OPENSSL_BIN_DIR}

source $HARBOR_JOB_DIR/bin/properties.sh

for dir in $RUN_DIR $LOG_DIR $HARBOR_PERSISTED_DATA ; do
  mkdir -p ${dir}
  chown vcap:vcap ${dir}
  chmod 755 ${dir}
done

#Link the data dir
if ! [ -L $HARBOR_DATA ]; then
  ln -s $HARBOR_PERSISTED_DATA $HARBOR_DATA
fi

# Cat out the harbor.cfg file content
cat ${CFG_FILE}

#Copy cert to the right place
mkdir -p $HARBOR_DATA/cert
mkdir -p $HARBOR_DATA/ca_download

cp ${HARBOR_JOB_DIR}/config/server.crt $HARBOR_DATA/cert/
cp ${HARBOR_JOB_DIR}/config/server.key $HARBOR_DATA/cert/
cp ${HARBOR_JOB_DIR}/config/ca.crt $HARBOR_DATA/ca_download

#Prepare Harbor env
PREPARE_OPTS="--conf ${CFG_FILE}"

#If install optional component Notary
if [ -n "$WITH_NOTARY" ]; then
  PREPARE_OPTS="${PREPARE_OPTS} --with-notary"
fi

#If install optional component Clair
if [ -n "$WITH_CLAIR" ]; then
  PREPARE_OPTS="${PREPARE_OPTS} --with-clair"
fi

${HARBOR_PACKAGE_DIR}/prepare ${PREPARE_OPTS}

#Workaround to resolve the docker-compose libz issue
sudo mount /tmp -o remount,exec

#For status checking script usage
CERT_PATH=$CERTS_D/${HARBOR_HOSTNAME}
mkdir -p $CERT_PATH
chown vcap:vcap ${CERT_PATH}
chmod 755 ${CERT_PATH}
cp $HARBOR_DATA/ca_download/ca.crt ${CERT_PATH}

#Enable status checking script
#Check with 5 minutes interval
CHECK_SCRIPT_PATH=${HARBOR_JOB_DIR}/bin/status_check
echo "*/5 * * * * root ${CHECK_SCRIPT_PATH} >> $LOG_DIR/cron.log 2>&1" > $CRON_PATH

exit 0